---
export interface DemoStep {
  id: string;
  title: string;
  description: string;
  image: string;
  alt: string;
  button?: {
    id: string;
    label: string;
    position: {
      left?: string;
      right?: string;
      top: string;
    };
    balloonLength?: string;
    balloonPos: string;
  };
  groupName?: string;
  groupNumber?: string;
}

export interface DemoGuide {
  title: string;
  subtitle?: string;
  mainSteps: Array<{
    number: string;
    title: string;
    id: string;
  }>;
  steps: DemoStep[];
}

interface Props {
  guides: DemoGuide;
}

const { guides } = Astro.props;
---

<div class="steps-guide">
  <div class="section-title">
    <h3 class="title mb-4">{guides.title}</h3>
    {guides.subtitle && <p class="text-muted para-desc mx-auto mb-0">{guides.subtitle}</p>}
  </div>
  <div class="row">
    {guides.mainSteps.map((step, index) => (
      <div class="col-md-4">
        <div class={`card features feature-clean work-process bg-transparent border-0 text-center ${index < guides.mainSteps.length - 1 ? 'process-arrow' : ''}`}>
          <div class={`card-body steps-title ${step.id}`} id={step.id}>
            <h6 class="text-dark">
              <span class="h2 fw-bold step">{step.number}. </span>{step.title}
            </h6>
          </div>
        </div>
      </div>
    ))}
  </div>
</div>

<div class="demo-wrap">
  <img
    src={guides.steps[0]?.image}
    alt={guides.steps[0]?.alt}
    class="img-fluid rounded-md shadow-lg"
    style="z-index: 0;"
  />

  <div class="steps-wrap">
    {guides.steps.map((step, index) => (
      <div class={`demo_step ${index === 0 ? 'demo_step_start' : ''}`} data-step={index}>
        <img
          data-src={step.image}
          src={index === 0 ? step.image : ""}
          alt={step.alt}
        />
        {step.button && (
          <div
            class="demo-button demo_tooltip"
            data-step-button={index}
            aria-label={step.button.label}
            data-balloon-length={step.button.balloonLength || "medium"}
            data-balloon-pos={step.button.balloonPos}
            style={`${step.button.position.left ? `left: ${step.button.position.left};` : ''}${step.button.position.right ? `right: ${step.button.position.right};` : ''}top: ${step.button.position.top};`}
          >
            <svg
              width="80"
              height="80"
              viewBox="0 0 45 45"
              xmlns="http://www.w3.org/2000/svg"
              stroke="#fa541c"
              aria-label="interactive-button"
            >
              <g
                fill="none"
                fill-rule="evenodd"
                transform="translate(1 1)"
                stroke-width="2"
              >
                <circle
                  cx="22"
                  cy="22"
                  r="6"
                  stroke-opacity="0"
                >
                  <animate
                    attributeName="r"
                    begin="1.5s"
                    dur="3s"
                    values="6;22"
                    calcMode="linear"
                    repeatCount="indefinite"
                  />
                  <animate
                    attributeName="stroke-opacity"
                    begin="1.5s"
                    dur="3s"
                    values="1;0"
                    calcMode="linear"
                    repeatCount="indefinite"
                  />
                  <animate
                    attributeName="stroke-width"
                    begin="1.5s"
                    dur="3s"
                    values="2;0"
                    calcMode="linear"
                    repeatCount="indefinite"
                  />
                </circle>
                <circle cx="22" cy="22" r="8">
                  <animate
                    attributeName="r"
                    begin="0s"
                    dur="1.5s"
                    values="6;1;2;3;4;5;6"
                    calcMode="linear"
                    repeatCount="indefinite"
                  />
                </circle>
                <circle 
                  cx="22" 
                  cy="22" 
                  r="3" 
                  fill="#fa541c" 
                  stroke="none"
                />
              </g>
            </svg>
          </div>
        )}
        {step.groupName && (
          <div class="steps-groups">
            <div class="steps-group-name">
              <span>{step.groupNumber}</span><br />{step.groupName}
            </div>
          </div>
        )}
      </div>
    ))}
  </div>
</div>

<style>
  /* 步骤导航样式 */
  .steps-guide {
    margin-bottom: 2rem;
  }

  .work-process {
    position: relative;
  }

  .work-process.process-arrow:after {
    content: '';
    position: absolute;
    width: 50%;
    height: 20px;
    top: 8px;
    left: 78%;
    background: url("../images/process.png") center center no-repeat;
  }

  .work-process .step {
    opacity: 0.3;
  }

  .steps-title {
    cursor: pointer;
    padding: 1.5rem 1rem;
    transition: all 0.3s ease;
  }

 

  .card-body h6 {
    margin-bottom: 0;
  }

  /* 激活状态的步骤样式 */
  .steps-guide .active h6 {
    color: #2f55d4 !important;
  }

  .steps-guide .active .step {
    opacity: 1 !important;
  }

  /* 演示区域样式 */
  .demo-wrap {
    position: relative;
    display: block;
    width: 100%;
  }

  .steps-wrap {
    opacity: 0;
  }

  .steps-wrap.loaded {
    opacity: 1;
  }

  /* 步骤样式 */
  .demo_step {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
  }

  .demo_step.demo_step_start {
    display: block;
  }

  .demo_step img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* 交互按钮样式 - 使用更具体的选择器防止冲突 */
  .demo-wrap .demo-button {
    position: absolute !important;
    width: 80px !important;
    height: 80px !important;
    display: none !important;
    cursor: pointer !important;
    z-index: 10 !important;
    border-radius: 50% !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s ease !important;
    border: none !important;
    background: none !important;
    padding: 0 !important;
  }

  .demo-wrap .demo-button.show {
    display: flex !important;
  }

  .demo-wrap .demo-button:hover {
    transform: scale(1.1) !important;
  }

  .demo-wrap .demo-button svg {
    width: 100% !important;
    height: 100% !important;
  }

  /* 完全移除tooltip效果 */
  .demo_tooltip::before {
    display: none !important;
  }

  .demo_tooltip:hover::before {
    display: none !important;
  }

  /* 自动提示样式 - 1秒后自动显示，根据balloonPos配置 */
  .demo-button.auto-tooltip::after {
    content: attr(aria-label);
    position: absolute;
    background: rgba(250, 84, 28, 0.9);
    color: white;
    padding: 10px 14px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: normal;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    z-index: 100;
    max-width: 200px;
    word-wrap: break-word;
    white-space: normal;
    line-height: 1.4;
    opacity: 1;
  }

  .demo-button.auto-tooltip::before {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    z-index: 100;
    opacity: 1;
  }

  /* 上方提示 */
  .demo-button.auto-tooltip[data-balloon-pos="up"]::after {
    bottom: 100%;
    left: 50%;
    margin-bottom: 5px;
    transform: translateX(-50%);
  }

  .demo-button.auto-tooltip[data-balloon-pos="up"]::before {
    bottom: 100%;
    left: 50%;
    margin-bottom: -1px;
    transform: translateX(-50%);
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-top: 6px solid rgba(250, 84, 28, 0.9);
  }

  /* 下方提示 */
  .demo-button.auto-tooltip[data-balloon-pos="down"]::after {
    top: 100%;
    left: 50%;
    margin-top: 5px;
    transform: translateX(-50%);
  }

  .demo-button.auto-tooltip[data-balloon-pos="down"]::before {
    top: 100%;
    left: 50%;
    margin-top: -1px;
    transform: translateX(-50%);
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-bottom: 6px solid rgba(250, 84, 28, 0.9);
  }

  /* 左侧提示 */
  .demo-button.auto-tooltip[data-balloon-pos="left"]::after {
    right: 100%;
    top: 50%;
    margin-right: 5px;
    transform: translateY(-50%);
    max-width: 180px;
  }

  .demo-button.auto-tooltip[data-balloon-pos="left"]::before {
    right: 100%;
    top: 50%;
    margin-right: -1px;
    transform: translateY(-50%);
    border-top: 9px solid transparent;
    border-bottom: 9px solid transparent;
    border-left: 6px solid rgba(250, 84, 28, 0.9);
  }

  /* 右侧提示 */
  .demo-button.auto-tooltip[data-balloon-pos="right"]::after {
    left: 100%;
    top: 50%;
    margin-left: 5px;
    transform: translateY(-50%);
    max-width: 180px;
  }

  .demo-button.auto-tooltip[data-balloon-pos="right"]::before {
    left: 100%;
    top: 50%;
    margin-left: -1px;
    transform: translateY(-50%);
    border-top: 9px solid transparent;
    border-bottom: 9px solid transparent;
    border-right: 6px solid rgba(250, 84, 28, 0.9);
  }

  @keyframes tooltipFadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* 为不同方向的提示框添加特定的动画 */
  .demo-button.auto-tooltip[data-balloon-pos="up"]::after,
  .demo-button.auto-tooltip[data-balloon-pos="up"]::before {
    animation: tooltipFadeInUp 0.18s ease-out;
  }

  .demo-button.auto-tooltip[data-balloon-pos="down"]::after,
  .demo-button.auto-tooltip[data-balloon-pos="down"]::before {
    animation: tooltipFadeInDown 0.18s ease-out;
  }

  .demo-button.auto-tooltip[data-balloon-pos="left"]::after,
  .demo-button.auto-tooltip[data-balloon-pos="left"]::before {
    animation: tooltipFadeInLeft 0.18s ease-out;
  }

  .demo-button.auto-tooltip[data-balloon-pos="right"]::after,
  .demo-button.auto-tooltip[data-balloon-pos="right"]::before {
    animation: tooltipFadeInRight 0.18s ease-out;
  }

  @keyframes tooltipFadeInUp {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-5px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  @keyframes tooltipFadeInDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  @keyframes tooltipFadeInLeft {
    from {
      opacity: 0;
      transform: translateY(-50%) translateX(-5px);
    }
    to {
      opacity: 1;
      transform: translateY(-50%) translateX(0);
    }
  }

  @keyframes tooltipFadeInRight {
    from {
      opacity: 0;
      transform: translateY(-50%) translateX(5px);
    }
    to {
      opacity: 1;
      transform: translateY(-50%) translateX(0);
    }
  }

  /* 步骤组标签样式 */
  .steps-groups {
    cursor: pointer;
    width: 100%;
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
    background: url("../images/step-bg.png") center center repeat;
    z-index: 5;
    pointer-events: none;
  }

  .steps-group-name {
    font-size: 24px;
    padding: 10%;
    pointer-events: auto;
  }

  .steps-group-name span {
    font-size: 72px;
    opacity: 0.3;
  }

  /* 可点击步骤的样式 */
  .clickable-step {
    position: relative;
  }

  .clickable-step::after {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(42, 85, 212, 0.9);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    z-index: 100;
    animation: pulse 2s infinite;
    white-space: nowrap;
  }

  /* 确保步骤容器正确定位 */
  .demo_step {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    display: none !important;
  }

  .demo_step.demo_step_start {
    display: block !important;
  }

  /* 修复可能的布局问题 */
  .demo-wrap {
    position: relative !important;
    display: block !important;
    width: 100% !important;
    overflow: hidden !important;
  }

  @keyframes pulse {
    0% {
      opacity: 0.8;
      transform: translateX(-50%) scale(1);
    }
    50% {
      opacity: 1;
      transform: translateX(-50%) scale(1.05);
    }
    100% {
      opacity: 0.8;
      transform: translateX(-50%) scale(1);
    }
  }

  /* 响应式样式 */
  @media (max-width: 768px) {
    .work-process {
      display: none;
    }
    
    /* 移动设备上的提示框样式优化 */
    .demo-button.auto-tooltip::after {
      max-width: 150px;
      font-size: 13px;
      padding: 8px 12px;
    }
    
    .demo-button.auto-tooltip[data-balloon-pos="left"]::after,
    .demo-button.auto-tooltip[data-balloon-pos="right"]::after {
      max-width: 120px;
    }
  }
</style>

<script>
  interface DemoInterface {
    currentStep: number;
    steps: NodeListOf<Element>;
    buttons: NodeListOf<Element>;
    init(): void;
    bindEvents(): void;
    preloadImages(): void;
    initializeFirstStep(): void;
    goToStep(stepIndex: number): void;
    reset(): void;
    next(): void;
    previous(): void;
    activateStep(stepIndex: number): void;
    updateStepNavigation(): void;
    markStepsLoaded(): void;
    showCurrentStepButton(): void;
    hideAllButtons(): void;
    jumpToMainStep(mainStepIndex: number): void;
    updateCurrentStepStyle(): void;
  }

  class InteractiveDemo implements DemoInterface {
    currentStep: number;
    steps: NodeListOf<Element>;
    buttons: NodeListOf<Element>;

    constructor() {
      this.currentStep = 0;
      this.steps = document.querySelectorAll('.demo_step');
      this.buttons = document.querySelectorAll('.demo-button');
      this.init();
    }

    init(): void {
      this.bindEvents();
      this.preloadImages();
      this.initializeFirstStep();
      this.updateStepNavigation();
      this.markStepsLoaded();
    }

    markStepsLoaded(): void {
      const stepsWrap = document.querySelector('.steps-wrap');
      if (stepsWrap) {
        stepsWrap.classList.add('loaded');
      }
    }

    initializeFirstStep(): void {
      console.log(`总步骤数：${this.steps.length}`);
      
      // 隐藏所有步骤
      this.steps.forEach((step, index) => {
        const stepElement = step as HTMLElement;
        if (index === 0) {
          stepElement.style.display = 'block';
          stepElement.style.setProperty('display', 'block', 'important');
        } else {
          stepElement.style.display = 'none';
          stepElement.style.setProperty('display', 'none', 'important');
        }
        console.log(`步骤 ${index} 设置为：${index === 0 ? 'block' : 'none'}`);
      });
      
      // 显示第一个步骤的按钮
      console.log(`初始化：当前步骤 ${this.currentStep}`);
      console.log(`找到的按钮数量：${this.buttons.length}`);
      this.showCurrentStepButton();
      
      // 更新第一个步骤的样式
      this.updateCurrentStepStyle();
    }

    hideAllButtons(): void {
      this.buttons.forEach((button) => {
        const buttonElement = button as HTMLElement;
        buttonElement.classList.remove('show');
        buttonElement.classList.remove('auto-tooltip');
        // 在切换步骤时重置提示框状态，让新步骤的按钮可以重新显示提示
        delete buttonElement.dataset.tooltipHidden;
      });
    }

    showCurrentStepButton(): void {
      this.hideAllButtons();
      
      // 检查当前步骤是否有按钮配置
      const currentButton = document.querySelector(`[data-step-button="${this.currentStep}"]`) as HTMLElement;
      if (currentButton) {
        currentButton.classList.add('show');
        console.log(`显示步骤 ${this.currentStep} 的按钮`);
        
        // 等待1秒后自动显示提示，但只在首次显示时或用户未手动隐藏时
        setTimeout(() => {
          if (!currentButton.dataset.tooltipHidden) {
            currentButton.classList.add('auto-tooltip');
          }
        }, 1000);
      } else {
        console.log(`步骤 ${this.currentStep} 没有按钮配置`);
      }
    }

    bindEvents(): void {
      // 绑定按钮点击事件
      this.buttons.forEach((button) => {
        button.addEventListener('click', () => {
          const stepIndex = parseInt((button as HTMLElement).dataset.stepButton || '0');
          console.log(`点击步骤 ${stepIndex} 的按钮`);
          
          // 检查是否是最后一步
          if (stepIndex === this.steps.length - 1) {
            console.log(`按钮在最后一步，循环回第一步`);
            this.goToStep(0);
          } else {
            // 点击按钮跳转到下一个步骤
            this.goToStep(stepIndex + 1);
          }
        });

        // 添加鼠标悬停事件监听器
        button.addEventListener('mouseenter', () => {
          // 鼠标进入时不做任何处理，保持当前状态
        });

        button.addEventListener('mouseleave', () => {
          // 鼠标离开时隐藏提示框，并标记为已被用户隐藏
          const buttonElement = button as HTMLElement;
          buttonElement.classList.remove('auto-tooltip');
          buttonElement.dataset.tooltipHidden = 'true';
        });
      });

      // 绑定步骤导航点击事件
      const stepTitles = document.querySelectorAll('.steps-title');
      stepTitles.forEach((stepTitle, index) => {
        stepTitle.addEventListener('click', () => {
          this.jumpToMainStep(index);
        });
      });

      // 绑定所有步骤的点击事件（适用于没有按钮的步骤，特别是灰色导航页面）
      this.steps.forEach((step, index) => {
        const stepElement = step as HTMLElement;
        
        // 给所有步骤添加点击事件
        stepElement.addEventListener('click', (e) => {
          // 如果点击的是按钮，不处理（让按钮自己处理）
          if ((e.target as HTMLElement).closest('.demo-button')) {
            return;
          }
          
          // 如果是当前步骤且没有按钮配置，就跳转到下一步
          if (index === this.currentStep) {
            const hasButtonConfig = document.querySelector(`[data-step-button="${this.currentStep}"]`);
            if (!hasButtonConfig) {
              console.log(`点击无按钮配置的步骤 ${index}，跳转到下一步`);
              
              // 检查是否是最后一步
              if (index === this.steps.length - 1) {
                console.log(`到达最后一步，循环回第一步`);
                this.goToStep(0);
              } else {
                this.goToStep(index + 1);
              }
            }
          }
        });
      });
    }

    // 为当前步骤添加适当的样式
    updateCurrentStepStyle(): void {
      // 移除所有步骤的特殊样式
      this.steps.forEach((step) => {
        const stepElement = step as HTMLElement;
        stepElement.classList.remove('clickable-step');
        stepElement.style.cursor = 'default';
      });

      // 为当前步骤添加样式
      const currentStepElement = this.steps[this.currentStep] as HTMLElement;
      
      // 检查当前步骤是否有按钮配置
      const hasButtonConfig = document.querySelector(`[data-step-button="${this.currentStep}"]`);
      
      if (!hasButtonConfig) {
        // 如果没有按钮配置，添加可点击样式（灰色导航页面）
        currentStepElement.classList.add('clickable-step');
        currentStepElement.style.cursor = 'pointer';
        console.log(`步骤 ${this.currentStep} 是灰色导航页面，添加可点击样式`);
      } else {
        console.log(`步骤 ${this.currentStep} 有按钮，使用默认样式`);
      }
    }

    // 跳转到主步骤的第一个子步骤
    jumpToMainStep(mainStepIndex: number): void {
      let targetStep = 0;
      
      // 根据主步骤索引确定目标步骤（灰色导航页面的位置）
      if (mainStepIndex === 0) {
        targetStep = 1; // 跳转到第1步："01 创建数据表和字段"
      } else if (mainStepIndex === 1) {
        targetStep = 6; // 跳转到第6步："02 配置菜单和页面"
      } else if (mainStepIndex === 2) {
        targetStep = 10; // 跳转到第10步："03 在页面内布置区块和操作"
      }
      
      this.goToStep(targetStep);
    }

    preloadImages(): void {
      this.steps.forEach((step) => {
        const img = step.querySelector('img[data-src]') as HTMLImageElement;
        if (img && img.dataset.src) {
          const preloadImg = new Image();
          preloadImg.onload = () => {
            img.src = img.dataset.src!;
          };
          preloadImg.src = img.dataset.src;
        }
      });
    }

    goToStep(stepIndex: number): void {
      if (stepIndex >= 0 && stepIndex < this.steps.length) {
        console.log(`从步骤 ${this.currentStep} 跳转到步骤 ${stepIndex}`);
        
        // 首先隐藏所有步骤，确保没有重叠显示
        this.steps.forEach((step, index) => {
          const stepElement = step as HTMLElement;
          stepElement.style.display = 'none';
          stepElement.style.setProperty('display', 'none', 'important');
          stepElement.classList.remove('clickable-step');
        });
        
        // 隐藏所有按钮
        this.hideAllButtons();
        
        // 显示目标步骤
        this.currentStep = stepIndex;
        const targetStepElement = this.steps[this.currentStep] as HTMLElement;
        targetStepElement.style.display = 'block';
        targetStepElement.style.setProperty('display', 'block', 'important');
        
        console.log(`步骤 ${this.currentStep} 已显示`);
        
        // 显示当前步骤的按钮
        this.showCurrentStepButton();
        
        // 更新当前步骤的样式
        this.updateCurrentStepStyle();
        
        // 同步步骤导航状态
        this.updateStepNavigation();
      } else {
        console.log(`无效的步骤索引: ${stepIndex}`);
      }
    }

    // 公共方法：重置演示
    reset(): void {
      this.goToStep(0);
    }

    // 公共方法：下一步
    next(): void {
      if (this.currentStep < this.steps.length - 1) {
        this.goToStep(this.currentStep + 1);
      }
    }

    // 公共方法：上一步
    previous(): void {
      if (this.currentStep > 0) {
        this.goToStep(this.currentStep - 1);
      }
    }

    // 激活步骤导航
    activateStep(stepIndex: number): void {
      // 移除所有步骤的激活状态
      const stepTitles = document.querySelectorAll('.steps-title');
      stepTitles.forEach(stepTitle => {
        stepTitle.classList.remove('active');
      });

      // 激活当前步骤
      if (stepTitles[stepIndex]) {
        stepTitles[stepIndex].classList.add('active');
      }
    }

    // 更新步骤导航状态
    updateStepNavigation(): void {
      // 根据当前步骤找到对应的主步骤
      let mainStepIndex = 0;
      
      // 根据当前步骤确定主步骤（基于实际的灰色导航页面位置）
      if (this.currentStep >= 0 && this.currentStep <= 5) {
        mainStepIndex = 0; // 创建数据表和字段
      } else if (this.currentStep >= 6 && this.currentStep <= 9) {
        mainStepIndex = 1; // 配置菜单和页面
      } else if (this.currentStep >= 10) {
        mainStepIndex = 2; // 在页面内布置区块和操作
      }
      
      this.activateStep(mainStepIndex);
    }
  }

  // 初始化演示
  document.addEventListener('DOMContentLoaded', () => {
    new InteractiveDemo();
  });

  // 导出全局访问
  declare global {
    interface Window {
      InteractiveDemo: typeof InteractiveDemo;
    }
  }

  if (typeof window !== 'undefined') {
    window.InteractiveDemo = InteractiveDemo;
  }
</script> 